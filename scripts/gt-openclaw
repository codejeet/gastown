#!/bin/bash
# Gas Town OpenClaw Integration
# Higher-level commands that leverage OpenClaw's native features

set -e

GT_HOME="${GT_HOME:-$HOME/.openclaw/workspace/gastown}"
GT_CONFIG="$GT_HOME/config/town.json"
GT_ROLES="$GT_HOME/config/roles.json"
GT_BEADS="$GT_HOME/beads/beads.jsonl"
GT_HOOKS="$GT_HOME/beads/hooks.jsonl"
GT_ACTIVITY="$GT_HOME/activity.jsonl"

# Import functions from gt (but not the main dispatch)
gen_id() {
  local prefix="$1"
  echo "${prefix}-$(head -c 4 /dev/urandom | xxd -p)"
}

log_activity() {
  local type="$1"
  local message="$2"
  local worker="${3:-system}"
  local ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  echo "{\"ts\":\"$ts\",\"type\":\"$type\",\"worker\":\"$worker\",\"message\":\"$message\"}" >> "$GT_ACTIVITY"
}

create_bead() {
  local title="$1"
  local id=$(gen_id "bd")
  local ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  local bead="{\"id\":\"$id\",\"title\":\"$title\",\"status\":\"ready\",\"assignee\":null,\"createdAt\":\"$ts\",\"updatedAt\":\"$ts\"}"
  echo "$bead" >> "$GT_BEADS"
  log_activity "bead_created" "Created bead $id: $title"
  echo "$id"
}

create_hook() {
  local worker="$1"
  local bead_id="$2"
  local id=$(gen_id "hook")
  local ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  local hook="{\"id\":\"$id\",\"worker\":\"$worker\",\"beadId\":\"$bead_id\",\"status\":\"pending\",\"createdAt\":\"$ts\"}"
  echo "$hook" >> "$GT_HOOKS"
  log_activity "hook_created" "Created hook $id for $worker with bead $bead_id" "$worker"
  echo "$id"
}

get_hook() {
  local worker="$1"
  grep "\"worker\":\"$worker\"" "$GT_HOOKS" | grep "\"status\":\"pending\"" | head -1 || echo ""
}

create_convoy() {
  local title="$1"
  local bead_ids="$2"
  local id=$(gen_id "convoy")
  local ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  local convoy="{\"id\":\"$id\",\"title\":\"$title\",\"beads\":[$bead_ids],\"status\":\"active\",\"createdAt\":\"$ts\"}"
  jq --argjson c "$convoy" '.convoys += [$c]' "$GT_CONFIG" > "$GT_CONFIG.tmp" && mv "$GT_CONFIG.tmp" "$GT_CONFIG"
  log_activity "convoy_created" "Created convoy $id: $title"
  echo "$id"
}

# Spawn a polecat using sessions_spawn
spawn_polecat() {
  local task="$1"
  local polecat_id="polecat-$(date +%s)"

  local bead_id=$(create_bead "$task")
  local hook_id=$(create_hook "$polecat_id" "$bead_id")
  local convoy_id=$(create_convoy "$task" "\"$bead_id\"")

  log_activity "polecat_spawned" "Spawning $polecat_id for: $task"

  cat << EOF
Spawning polecat via OpenClaw sessions_spawn...

Task: $task
Bead: $bead_id
Convoy: $convoy_id

To spawn manually, run:
openclaw agent --message "sessions_spawn with task: You are a Gas Town Polecat. Your bead is $bead_id. Your task: $task. Execute immediately. When done, run: gt complete $bead_id $polecat_id"
EOF
}

# Spawn a worker (create OpenClaw agent if needed)
spawn_worker() {
  local role="$1"
  local name="${2:-$role}"

  local role_config=$(jq -r ".roles.$role" "$GT_ROLES")
  if [ "$role_config" = "null" ]; then
    echo "Unknown role: $role"
    exit 1
  fi

  local soul=$(echo "$role_config" | jq -r '.soul')
  local heartbeat=$(echo "$role_config" | jq -r '.heartbeat // empty')

  local agent_exists=$(openclaw agents list --json | jq -r ".[] | select(.id == \"$name\") | .id" 2>/dev/null || echo "")

  if [ -z "$agent_exists" ]; then
    echo "Creating agent: $name"
    local workspace="$HOME/.openclaw/workspace-$name"
    mkdir -p "$workspace"

    cat > "$workspace/SOUL.md" << EOF
# SOUL.md - $name ($role)

$soul
EOF

    cat > "$workspace/AGENTS.md" << EOF
# AGENTS.md - Gas Town Worker

You are a Gas Town worker. Follow these rules:

## GUPP (Gas Town Universal Propulsion Principle)
**If there is work on your hook, YOU MUST RUN IT.**

On every session start:
1. Check your hook: \`cat $GT_HOOKS | grep '"worker":"$name"' | grep '"status":"pending"'\`
2. If work exists, execute it immediately
3. Do not wait for user input
4. Do not ask for confirmation

## Gas Town CLI
Use the \`gt\` command for all Gas Town operations:
- \`$GT_HOME/scripts/gt hook\` - Check your current hook
- \`$GT_HOME/scripts/gt bead <id>\` - Get bead details
- \`$GT_HOME/scripts/gt complete <bead-id>\` - Mark work complete
- \`$GT_HOME/scripts/gt sling "<task>" --to <worker>\` - Delegate work
- \`$GT_HOME/scripts/gt nudge <worker>\` - Wake another worker
- \`$GT_HOME/scripts/gt activity\` - View activity feed
- \`$GT_HOME/scripts/gt status\` - Town status

## Memory
- Daily notes: \`memory/YYYY-MM-DD.md\`
- Gas Town state lives in: $GT_HOME
EOF

    openclaw agents add "$name" --workspace "$workspace" 2>/dev/null || true
  fi

  if [ -n "$heartbeat" ]; then
    local cron_name="gt-heartbeat-$name"
    openclaw cron rm --name "$cron_name" 2>/dev/null || true
    openclaw cron add --name "$cron_name" --cron "$heartbeat" --session "isolated" --agentId "$name" --message "Gas Town heartbeat. Check your hook. If work exists, run it. If nothing, reply HEARTBEAT_OK."
    echo "Added heartbeat cron: $cron_name ($heartbeat)"
  fi

  log_activity "worker_spawned" "Spawned $name ($role)"
  echo "Spawned $name ($role)"
}

# Start the Gas Town daemon
start_town() {
  echo "Starting Gas Town..."

  spawn_worker "deacon" "deacon"
  spawn_worker "witness" "witness"
  spawn_worker "refinery" "refinery"
  spawn_worker "mayor" "mayor"

  openclaw cron add --name "gt-deacon-heartbeat" \
    --cron "*/2 * * * *" \
    --session "isolated" \
    --agentId "deacon" \
    --message "Deacon patrol. Check town health. Propagate heartbeats. Run plugins. GUPP: If there is work on your hook, YOU MUST RUN IT." \
    2>/dev/null || true

  openclaw cron add --name "gt-boot-check" \
    --cron "*/5 * * * *" \
    --session "isolated" \
    --message "Boot check. Is the Deacon running? Check gt status. If Deacon is stuck, nudge it. Reply HEARTBEAT_OK if all is well." \
    2>/dev/null || true

  log_activity "town_started" "Gas Town is running"
  echo "Gas Town is running. Deacon heartbeat active."

  "$GT_HOME/scripts/gt" status
}

# Stop the Gas Town daemon
stop_town() {
  echo "Stopping Gas Town..."

  openclaw cron rm --name "gt-deacon-heartbeat" 2>/dev/null || true
  openclaw cron rm --name "gt-boot-check" 2>/dev/null || true
  openclaw cron rm --name "gt-heartbeat-mayor" 2>/dev/null || true
  openclaw cron rm --name "gt-heartbeat-witness" 2>/dev/null || true
  openclaw cron rm --name "gt-heartbeat-refinery" 2>/dev/null || true

  log_activity "town_stopped" "Gas Town stopped"
  echo "Gas Town stopped."
}

# Swarm: spawn multiple polecats
swarm() {
  local count="${1:-3}"
  shift
  local tasks=("$@")

  echo "Spawning swarm of $count polecats..."

  for i in $(seq 1 $count); do
    if [ ${#tasks[@]} -gt 0 ]; then
      local task="${tasks[$((i-1))]}"
      if [ -n "$task" ]; then
        spawn_polecat "$task"
      fi
    fi
  done

  log_activity "swarm_spawned" "Spawned swarm of $count polecats"
}

# Cook a formula into a molecule
cook_formula() {
  local formula_name="$1"
  shift
  local vars=("$@")

  local formula_file="$GT_HOME/formulas/$formula_name.toml"
  if [ ! -f "$formula_file" ]; then
    echo "Formula not found: $formula_name"
    exit 1
  fi

  echo "Cooking formula: $formula_name"

  declare -A var_map
  for var in "${vars[@]}"; do
    key="${var%%=*}"
    value="${var#*=}"
    var_map[$key]="$value"
  done

  local mol_id=$(gen_id "mol")
  local mol_file="$GT_HOME/molecules/$mol_id.jsonl"

  local step_ids=()
  local current_step=""
  while IFS= read -r line; do
    if [[ "$line" =~ ^\[\[steps\]\] ]]; then
      current_step=""
    elif [[ "$line" =~ ^id\ =\ \"(.*)\" ]]; then
      current_step="${BASH_REMATCH[1]}"
    elif [[ "$line" =~ ^title\ =\ \"(.*)\" ]]; then
      local title="${BASH_REMATCH[1]}"
      for key in "${!var_map[@]}"; do
        title="${title//\{\{$key\}\}/${var_map[$key]}}"
      done
      local bead_id=$(create_bead "$title")
      step_ids+=("$bead_id")
      echo "{\"step\":\"$current_step\",\"beadId\":\"$bead_id\"}" >> "$mol_file"
    fi
  done < "$formula_file"

  log_activity "formula_cooked" "Cooked $formula_name into molecule $mol_id with ${#step_ids[@]} steps"

  echo "Created molecule: $mol_id"
  echo "Steps: ${step_ids[*]}"
}

# List formulas
list_formulas() {
  echo "Available Formulas:"
  for f in "$GT_HOME/formulas"/*.toml; do
    if [ -f "$f" ]; then
      local name=$(basename "$f" .toml)
      local desc=$(grep '^description' "$f" | head -1 | sed 's/description = "\(.*\)"/\1/')
      echo "  $name: $desc"
    fi
  done
}

# Dashboard view
dashboard() {
  clear
  echo "========================================"
  echo "         GAS TOWN DASHBOARD             "
  echo "========================================"
  echo ""

  echo "-- WORKERS --"
  for role in mayor deacon witness refinery; do
    local hook=$(get_hook "$role" 2>/dev/null)
    local emoji=$(jq -r ".roles.$role.emoji" "$GT_ROLES" 2>/dev/null)
    if [ -n "$hook" ]; then
      local bead_id=$(echo "$hook" | jq -r '.beadId' 2>/dev/null)
      echo "  $emoji $role: WORKING on $bead_id"
    else
      echo "  $emoji $role: idle"
    fi
  done
  echo ""

  echo "-- ACTIVE CONVOYS --"
  jq -r '.convoys[] | select(.status == "active") | "  \(.id): \(.title)"' "$GT_CONFIG" 2>/dev/null || echo "  (none)"
  echo ""

  echo "-- MERGE QUEUE --"
  local queue_count=$(grep '"status":"review"' "$GT_BEADS" 2>/dev/null | wc -l)
  echo "  Pending MRs: $queue_count"
  echo ""

  echo "-- RECENT ACTIVITY --"
  tail -5 "$GT_ACTIVITY" 2>/dev/null | while read line; do
    local ts=$(echo "$line" | jq -r '.ts' 2>/dev/null | cut -c12-19)
    local worker=$(echo "$line" | jq -r '.worker' 2>/dev/null)
    local msg=$(echo "$line" | jq -r '.message' 2>/dev/null | cut -c1-50)
    echo "  $ts [$worker] $msg"
  done
}

# Main dispatch
case "${1:-help}" in
  start)
    start_town
    ;;
  stop)
    stop_town
    ;;
  spawn)
    spawn_worker "$2" "$3"
    ;;
  swarm)
    shift
    swarm "$@"
    ;;
  cook)
    shift
    cook_formula "$@"
    ;;
  formulas)
    list_formulas
    ;;
  dashboard)
    dashboard
    ;;
  polecat)
    shift
    spawn_polecat "$@"
    ;;
  help|--help|-h)
    echo "Gas Town OpenClaw Integration"
    echo ""
    echo "Usage: gto <command> [args...]"
    echo ""
    echo "Commands:"
    echo "  start                   Start Gas Town (spawn all workers)"
    echo "  stop                    Stop Gas Town (remove crons)"
    echo "  spawn <role> [name]     Spawn a worker"
    echo "  polecat <task>          Spawn ephemeral polecat"
    echo "  swarm <n> <tasks...>    Spawn multiple polecats"
    echo "  cook <formula> [vars]   Cook formula into molecule"
    echo "  formulas                List available formulas"
    echo "  dashboard               Show dashboard"
    echo ""
    echo "For basic operations, use: gt <command>"
    ;;
  *)
    # Pass through to base gt script
    "$GT_HOME/scripts/gt" "$@"
    ;;
esac
